<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RawBlock CUDA Analytics - Real-time Mempool</title>
    <style>
        :root {
            --bg-color: #0b0f19;
            --surface-color: #1a1f2e;
            --text-primary: #f0f2f5;
            --text-secondary: #8b94a5;
            --accent: #00ffcc;
            --accent-glow: rgba(0, 255, 204, 0.3);
            --danger: #ff4757;
            --success: #2ed573;
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            padding: 1.5rem 0;
            text-align: center;
            background: linear-gradient(180deg, rgba(26, 31, 46, 0.8) 0%, transparent 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }

        h1 span {
            color: var(--accent);
            text-shadow: 0 0 15px var(--accent-glow);
        }

        .status-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            transition: all 0.3s ease;
        }

        .status-dot.connected {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        main {
            width: 90%;
            max-width: 1200px;
        }

        .table-container {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th,
        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: rgba(255, 255, 255, 0.02);
        }

        tr {
            transition: background-color 0.2s ease;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .txid {
            font-family: 'Courier New', Courier, monospace;
            color: var(--accent);
            text-decoration: none;
        }

        .txid:hover {
            text-decoration: underline;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            background-color: rgba(255, 255, 255, 0.1);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .badge.cuda {
            background: rgba(0, 255, 204, 0.15);
            color: var(--accent);
            border: 1px solid var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .badge.flag.cj {
            background: rgba(160, 32, 240, 0.2);
            color: #d8b4fe;
            border: 1px solid #d8b4fe;
        }

        .badge.flag.wp {
            background: rgba(56, 189, 248, 0.2);
            color: #38bdf8;
            border: 1px solid #38bdf8;
        }

        .badge.flag.ws {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .badge.flag.reuse {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            border: 1px solid #f87171;
        }

        .badge.flag.pj {
            background: rgba(250, 204, 21, 0.2);
            color: #facc15;
            border: 1px solid #facc15;
        }

        .badge.flag.none {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .score-bar {
            width: 100px;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        .score-fill {
            height: 100%;
            background-color: var(--success);
            transition: width 0.5s ease;
        }

        .score-fill.low {
            background-color: var(--danger);
        }

        .score-fill.medium {
            background-color: #ffa502;
        }

        @keyframes unshift {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-row {
            animation: unshift 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .time-ms {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <header>
        <h1>RawBlock <span>CUDA Core</span></h1>
        <div class="status-container">
            <div id="statusIndicator" class="status-dot"></div>
            <span id="statusText">Connecting to Stream...</span>
        </div>
    </header>

    <main>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Topology & Volume</th>
                        <th>Privacy Score</th>
                        <th>Forensics (Conclusion)</th>
                        <th>Inference (LLR)</th>
                        <th>Proc. Time</th>
                        <th>Accelerator</th>
                    </tr>
                </thead>
                <tbody id="txTableBody">
                    <!-- Rows will be injected here via websocket -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        const tableBody = document.getElementById('txTableBody');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const maxRows = 20; // Maximum number of TXs to display at once

        function connectWebSocket() {
            // Use the same host but switch protocol to ws/wss
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Assuming this is served from localhost:5339/dashboard
            // The API stream endpoint is at /api/v1/stream
            const wsUrl = `${protocol}//${window.location.host}/api/v1/stream`;

            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusIndicator.classList.add('connected');
                statusText.innerText = 'Connected (Live Mempool Stream)';
                console.log('Connected to RawBlock CUDA Engine stream');
            };

            ws.onclose = () => {
                statusIndicator.classList.remove('connected');
                statusText.innerText = 'Disconnected. Reconnecting...';
                // Attempt to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.error('WebSocket Error:', err);
                ws.close();
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addTransactionRow(data);
                } catch (e) {
                    console.error('Failed to parse WS message:', e);
                }
            };
        }

        function getScoreColorClass(score) {
            if (score <= 33) return 'low';
            if (score <= 66) return 'medium';
            return 'high';
        }

        function getForensicsLabels(flags) {
            const labels = [];

            // Layer 1: Deterministic
            if (flags & 1) labels.push('<span class="badge flag none">SegWit</span>');
            if (flags & 2) labels.push('<span class="badge flag none">Taproot</span>');
            if (flags & 4) labels.push('<span class="badge flag none">Schnorr</span>');
            if (flags & 8) labels.push('<span class="badge flag wp">Whirlpool</span>');

            // Layer 2: Probabilistic
            if (flags & 1024) labels.push('<span class="badge flag" style="color:#d8b4fe; border: 1px solid #d8b4fe;">Likely Change</span>');
            if (flags & 2048) labels.push('<span class="badge flag cj">CoinJoin</span>');
            if (flags & 4096) labels.push('<span class="badge flag reuse">Address Reuse</span>');

            // Layer 3: Policy-Gated
            if (flags & 1048576) labels.push('<span class="badge flag pj">MuSig2 Suspect</span>');
            if (flags & 2097152) labels.push('<span class="badge flag pj">PayJoin Suspect</span>');
            if (flags & 4194304) labels.push('<span class="badge flag ws">Silent Pymt</span>');
            if (flags & 8388608) labels.push('<span class="badge flag ws">WabiSabi Suspect</span>');
            if (flags & 16777216) labels.push('<span class="badge flag" style="background: rgba(255,165,0,0.2); color: orange; border: 1px solid orange;">JoinMarket Bond</span>');

            if (labels.length === 0) {
                labels.push('<span class="badge flag none">Standard Tx</span>');
            }
            return labels.join('');
        }

        function getInferenceHtml(inference) {
            if (!inference) return '<span style="color:var(--text-secondary); font-size: 0.85rem;">N/A (No Graph)</span>';
            let confColor = 'var(--text-secondary)';
            if (inference.confidenceLevel === 'high') confColor = 'var(--success)';
            if (inference.confidenceLevel === 'medium') confColor = '#ffa502';
            if (inference.confidenceLevel === 'low') confColor = 'var(--danger)';

            return `<div style="font-size: 0.85rem">
                <span style="color: ${confColor}; font-weight: 600;">[${inference.confidenceLevel.toUpperCase()}]</span> 
                <br/>LLR: ${inference.posteriorLlr.toFixed(2)}
            </div>`;
        }

        function addTransactionRow(data) {
            const tr = document.createElement('tr');
            tr.className = 'new-row';

            // Format TXID for display
            const shortTxid = `${data.txid.substring(0, 8)}...${data.txid.substring(data.txid.length - 8)}`;

            const scoreClass = getScoreColorClass(data.privacyScore);

            const hardwareBadge = data.cudaOffloaded
                ? `<span class="badge cuda">⚡ RTX CUDA</span>`
                : `<span class="badge">CPU</span>`;

            const forensicsHtml = getForensicsLabels(data.heuristicFlags);
            const inferenceHtml = getInferenceHtml(data.inference);

            tr.innerHTML = `
                <td><a href="https://mempool.space/tx/${data.txid}" target="_blank" class="txid">${shortTxid}</a></td>
                <td>
                    <div style="font-weight:600; font-size: 0.95rem; color: var(--text-primary);">${data.numInputs} × ${data.numOutputs}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; line-height: 1.4;">
                        Vol: <span style="color:#d8b4fe">${(data.totalIn / 100000000).toFixed(4)} BTC</span><br/>
                        Fee: <span style="color:#facc15">${data.fee} sats</span><br/>
                        Size: ${data.vsize} vB
                    </div>
                </td>
                <td>
                    <div class="score-bar"><div class="score-fill ${scoreClass}" style="width: ${data.privacyScore}%"></div></div>
                    <span>${data.privacyScore}</span> <span style="font-size: 0.8rem; color: #8b94a5;">(AS: ${data.anonSet})</span>
                </td>
                <td>${forensicsHtml}</td>
                <td>${inferenceHtml}</td>
                <td class="time-ms">${data.processingTimeMs.toFixed(2)} ms</td>
                <td>${hardwareBadge}</td>
            `;

            // Insert at top
            tableBody.prepend(tr);

            // Remove animation class after it completes so it isn't reapplied on re-render
            setTimeout(() => {
                tr.classList.remove('new-row');
            }, 500);

            // Keep table rows limited
            if (tableBody.children.length > maxRows) {
                tableBody.removeChild(tableBody.lastChild);
            }
        }

        // Initialize connection
        connectWebSocket();
    </script>
</body>

</html>